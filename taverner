#!/bin/bash --
# taverner - generate dmenu for launchers and display cover images
# requires dmenu-pango-imlib

warn() {
    printf "%s: $1" taverner "${@:2}" >&2
}

datadir=${XDG_DATA_HOME:-$HOME/.local/share}/taverner

bindir=$datadir/bin

read -r font < "${XDG_CONFIG_HOME:-$HOME/.config}"/menu/font

dmenu_opts=(
    -i -w -ia top-gapless -is 200x250
    -fn "$font" -p 'LAUNCH'
    -sf '#c0c5ce' -sb '#343d46'
    -nf '#65737e' -nb '#343d46'
)

dmenu() {
    awk -F '\t' 'NF {print $2}'
}

mkdir -p -- "$bindir" || exit

declare -A titles
declare -A covers

shopt -s nullglob

for dir in "$bindir"/*; do
    if [[ -d $dir ]]; then
        title=$dir/title
        cover=$dir/cover

        read -r title < "$dir"/title

        titles[$title]=$dir/run
        covers[$title]=$cover
    fi
done

for title in "${!titles[@]}"; do
    printf 'IMG:%s\t%s' "${covers[$title]}" "$title"
done \
| sort \
| dmenu "${dmenu_opts[@]}" \
| while read -r pick; do
    if [[ $pick ]]; then
        entry=${titles[$pick]}

        if [[ -x $entry ]]; then
            "$entry" &
        else
            warn '%s: cannot find associated launcher\n' "$pick"
        fi
    fi
done
